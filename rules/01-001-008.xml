<?xml version='1.0'?>
<rules xmlns="http://www.loc.gov/bf2marc"
       xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
       xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
       xmlns:bf="http://id.loc.gov/ontologies/bibframe/"
       xmlns:bflc="http://id.loc.gov/ontologies/bflc/"
       xmlns:madsrdf="http://www.loc.gov/mads/rdf/v1#"
       xmlns:marc="http://www.loc.gov/MARC21/slim"
       xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

  <cf tag="001">
    <transform><xsl:value-of select="$vRecordId"/></transform>
  </cf>

  <cf tag="003">
    <switch>
      <case test="$pConversionAgency != 'DLC' and $pRecordId != ''">
        <transform><xsl:value-of select="$pConversionAgency"/></transform>
      </case>
      <case test="default">
        <switch>
          <case test="$vAdminMetadata/bf:identifiedBy/*[local-name()='Local' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local']/bf:assigner/*/*[local-name()='code']">
            <transform>
              <xsl:value-of select="$vAdminMetadata/bf:identifiedBy/*[local-name()='Local' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Local']/bf:assigner/*/*[local-name()='code']"/>
            </transform>
          </case>
          <case test="default"><transform><xsl:value-of select="$pConversionAgency"/></transform></case>
        </switch>
      </case>
    </switch>
  </cf>

  <switch>
    <case test="$vAdminMetadata/bf:changeDate">
      <switch>
        <case test="$vAdminMetadata/bf:changeDate/@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime'">
          <cf tag="005">
            <transform>
              <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),substring($vAdminMetadata/bf:changeDate,12,2),substring($vAdminMetadata/bf:changeDate,15,2),substring($vAdminMetadata/bf:changeDate,18,2),'.0')"/>
            </transform>
          </cf>
        </case>
        <case test="$vAdminMetadata/bf:changeDate/@rdf:datatype='http://www.w3.org/2001/XMLSchema#date'">
          <cf tag="005">
            <transform>
              <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),'000000.0')"/>
            </transform>
          </cf>
        </case>
        <!-- attempt to convert an un-typed value that appears to be xsd:dateTime -->
        <case test="string-length($vAdminMetadata/bf:changeDate) &gt;= 19 and
                    substring($vAdminMetadata/bf:changeDate,5,1) = '-' and
                    substring($vAdminMetadata/bf:changeDate,8,1) = '-' and
                    substring($vAdminMetadata/bf:changeDate,11,1) = 'T' and
                    substring($vAdminMetadata/bf:changeDate,14,1) = ':' and
                    substring($vAdminMetadata/bf:changeDate,17,1) = ':'">
          <cf tag="005">
            <transform>
              <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),substring($vAdminMetadata/bf:changeDate,12,2),substring($vAdminMetadata/bf:changeDate,15,2),substring($vAdminMetadata/bf:changeDate,18,2),'.0')"/>
            </transform>
          </cf>
        </case>
        <!-- attempt to convert an un-typed value that appears to be xsd:date -->
        <case test="string-length($vAdminMetadata/bf:changeDate) &gt;= 10 and
                    substring($vAdminMetadata/bf:changeDate,5,1) = '-' and
                    substring($vAdminMetadata/bf:changeDate,8,1) = '-'">
          <cf tag="005">
            <transform>
              <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,4),substring($vAdminMetadata/bf:changeDate,6,2),substring($vAdminMetadata/bf:changeDate,9,2),'000000.0')"/>
            </transform>
          </cf>
        </case>
        <!-- pass through something that appears to be ISO 8601 with no punctuation -->
        <!-- this will miss non-ASCII alpha characters -->
        <case test="string-length($vAdminMetadata/bf:changeDate) &gt;= 14 and
                    translate($vAdminMetadata/bf:changeDate,'-:.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ','') = $vAdminMetadata/bf:changeDate">
          <cf tag="005">
            <transform>
              <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,14),'.0')"/>
            </transform>
          </cf>
        </case>
        <case test="string-length($vAdminMetadata/bf:changeDate) &gt;= 8 and
                    translate($vAdminMetadata/bf:changeDate,'-:.abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ','') = $vAdminMetadata/bf:changeDate">
          <cf tag="005">
            <transform>
              <xsl:value-of select="concat(substring($vAdminMetadata/bf:changeDate,1,8),'000000.0')"/>
            </transform>
          </cf>
        </case>
        <case test="default">
          <transform>
            <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:changeDate. Invalid datatype for 005.</xsl:message>
          </transform>
        </case>
      </switch>
    </case>
  </switch>

  <cf tag="008">
    <context xpath="/rdf:RDF">
      <var name="v008Format">
        <switch>
          <case test="bf:Instance/bf:issuance/bf:Issuance[@rdf:about='http://id.loc.gov/vocabulary/issuance/serl'] or
                      bf:Instance/bf:issuance[@rdf:resource='http://id.loc.gov/vocabulary/issuance/serl'] or
                      bf:Instance/bf:issuance/bf:Issuance[@rdf:about='http://id.loc.gov/vocabulary/issuance/intg'] or
                      bf:Instance/bf:issuance[@rdf:resource='http://id.loc.gov/vocabulary/issuance/intg']">CR</case>
          <case test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Cartography']">MP</case>
          <case test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Audio'] or
                      bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/NotatedMusic']">MU</case>
          <case test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MovingImage'] or
                      bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/StillImage'] or
                      bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Object']">VM</case>
          <case test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/MixedMaterial']">MX</case>
          <case test="bf:Work/rdf:type[@rdf:resource='http://id.loc.gov/ontologies/bibframe/Electronic']">CF</case>
          <case test="default">BK</case>
        </switch>
      </var>
      <fixed-field>
        <!-- 00-05 -->
        <position default="700101">
          <switch>
            <case test="$vAdminMetadata/bf:creationDate">
              <select xpath="$vAdminMetadata/bf:creationDate">
                <switch>
                  <case test="@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date' or @rdf:datatype='http://id.loc.gov/datatypes/edtf'">
                    <transform><xsl:value-of select="translate(substring(.,3,8),'-','')"/></transform>
                  </case>
                  <case test="default">
                    <transform>
                      <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:creationDate. Invalid datatype.</xsl:message>
                    </transform>
                  </case>
                </switch>
              </select>
            </case>
            <case test="$pGenerationDatestamp != ''">
              <transform><xsl:value-of select="translate(substring($pGenerationDatestamp,3,8),'-','')"/></transform>
            </case>
          </switch>
        </position>

        <!-- 06-14 -->
        <position default="|||||||||">
          <!-- there could easily be multiple provisionActivity properties, so there will be warnings -->
          <!-- some date types are difficult to build from BIBFRAME, so keep this simple for now -->
          <select xpath="bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:date|bf:Instance/bf:provisionActivity/*[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ProvisionActivity']/bf:date">
            <switch>
              <case test="@rdf:datatype='http://www.w3.org/2001/XMLSchema#dateTime' or @rdf:datatype='http://www.w3.org/2001/XMLSchema#date'">
                <transform><xsl:value-of select="concat('s',substring(.,1,4),'    ')"/></transform>
              </case>
              <case test="@rdf:datatype='http://id.loc.gov/datatypes/edtf'">
                <switch>
                  <case test="contains(.,'/')">
                    <switch>
                      <case test="local-name(parent::*)='Production' or parent::*[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Production']">
                        <transform><xsl:value-of select="concat('i',translate(substring(.,1,4),'X','u'),translate(substring(substring-after(.,'/'),1,4),'X','u'))"/></transform>
                      </case>
                      <case test="default">
                        <switch>
                          <case test="substring-after(.,'/')='..'">
                            <transform><xsl:value-of select="concat('c',translate(substring(.,1,4),'X','u'),'    ')"/></transform>
                          </case>
                          <case test="default">
                            <switch>
                              <case test="ancestor::bf:Instance/bf:issuance/bf:Issuance/@rdf:about='http://id.loc.gov/vocabulary/issuance/serl' or ancestor::bf:Instance/bf:issuance/@rdf:resource='http://id.loc.gov/vocabulary/issuance/serl'">
                                <transform><xsl:value-of select="concat('d',translate(substring(.,1,4),'X','u'),translate(substring(substring-after(.,'/'),1,4),'X','u'))"/></transform>
                              </case>
                              <case test="contains(.,'~') or contains(.,'?') or contains(.,'%')">
                                <transform><xsl:value-of select="concat('q',translate(substring(.,1,4),'X','u'),translate(substring(substring-after(.,'/'),1,4),'X','u'))"/></transform>
                              </case>
                              <case test="default">
                                <transform><xsl:value-of select="concat('m',translate(substring(.,1,4),'X','u'),translate(substring(substring-after(.,'/'),1,4),'X','u'))"/></transform>
                              </case>
                            </switch>
                          </case>
                        </switch>
                      </case>
                    </switch>
                  </case>
                  <case test="default">
                    <switch>
                      <case test="ancestor::bf:Instance/bf:copyrightDate and
                                  ancestor::bf:Instance/bf:copyrightDate/@rdf:datatype='http://id.loc.gov/datatypes/edtf'">
                        <transform><xsl:value-of select="concat('t',translate(substring(.,1,4),'X','u'),translate(substring(ancestor::bf:Instance/bf:copyrightDate,1,4),'X','u'))"/></transform>
                      </case>
                      <case test="contains(.,'~') or contains(.,'?') or contains(.,'%')">
                        <transform><xsl:value-of select="concat('q',translate(substring(.,1,4),'X','u'),'    ')"/></transform>
                      </case>
                      <case test="default">
                        <transform><xsl:value-of select="concat('s',translate(substring(.,1,4),'X','u'),'    ')"/></transform>
                      </case>
                    </switch>
                  </case>
                </switch>
              </case>
              <case test="default">
                <transform>
                  <xsl:message>Record <xsl:value-of select="$vRecordId"/>: Unprocessed bf:ProvisionActivity date. Invalid datatype.</xsl:message>
                </transform>
              </case>
            </switch>
          </select>
        </position>

        <!-- 15-17 -->
        <position default="xx ">
          <!-- there could easily be multiple provisionActivity properties, so there will be warnings -->
          <select xpath="bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place[@rdf:resource]|
                         bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place[*/@rdf:about]|
                         bf:Instance/bf:provisionActivity/bf:ProvisionActivity/bf:place[*/*[local-name()='code']]|
                         bf:Instance/bf:provisionActivity/*[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ProvisionActivity']/bf:place[@rdf:resource]|
                         bf:Instance/bf:provisionActivity/*[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ProvisionActivity']/bf:place[*/@rdf:about]|
                         bf:Instance/bf:provisionActivity/*[rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/ProvisionActivity']/bf:place[*/*[local-name()='code']]">
            <switch>
              <case test="*/*[local-name()='code']">
                <switch>
                  <case test="string-length(*/*[local-name()='code']) = 3">
                    <transform><xsl:value-of select="*/*[local-name()='code']"/></transform>
                  </case>
                  <case test="string-length(*/*[local-name()='code']) = 2">
                    <transform><xsl:value-of select="concat(*/*[local-name()='code'],' ')"/></transform>
                  </case>
                </switch>
              </case>
              <case test="*[starts-with(@rdf:about,'http://id.loc.gov/vocabulary/countries/')] or starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/countries/')">
                <transform>
                  <xsl:variable name="vCode">
                    <xsl:choose>
                      <xsl:when test="*[starts-with(@rdf:about,'http://id.loc.gov/vocabulary/countries/')]">
                        <xsl:value-of select="substring-after(*/@rdf:about,'http://id.loc.gov/vocabulary/countries/')"/>
                      </xsl:when>
                      <xsl:when test="starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/countries/')">
                        <xsl:value-of select="substring-after(@rdf:resource,'http://id.loc.gov/vocabulary/countries/')"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:choose>
                    <xsl:when test="string-length($vCode)=3"><xsl:value-of select="$vCode"/></xsl:when>
                    <xsl:when test="string-length($vCode)=2">
                      <xsl:value-of select="concat($vCode,' ')"/>
                    </xsl:when>
                  </xsl:choose>
                </transform>
              </case>
            </switch>
          </select>
        </position>

        <!-- 18-21 -->
        <position default="    ">
          <switch>
            <case test="$v008Format='BK'">
              <transform>
                <xsl:variable name="vIllus">
                  <xsl:for-each select="*/bf:illustrativeContent">
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/ill' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/ill' or
                                      */*[local-name()='code']='ill'">a</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/map' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/map' or
                                      */*[local-name()='code']='map'">b</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/por' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/por' or
                                      */*[local-name()='code']='por'">c</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/chr' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/chr' or
                                      */*[local-name()='code']='chr'">d</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/pln' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/pln' or
                                      */*[local-name()='code']='pln'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/plt' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/plt' or
                                      */*[local-name()='code']='plt'">f</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/mus' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/mus' or
                                      */*[local-name()='code']='mus'">g</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/fac' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/fac' or
                                      */*[local-name()='code']='fac'">h</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/coa' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/coa' or
                                      */*[local-name()='code']='coa'">i</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/gnt' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/gnt' or
                                      */*[local-name()='code']='gnt'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/for' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/for' or
                                      */*[local-name()='code']='for'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/sam' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/sam' or
                                      */*[local-name()='code']='sam'">l</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/pho' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/pho' or
                                      */*[local-name()='code']='pho'">m</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/pht' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/pht' or
                                      */*[local-name()='code']='pht'">o</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/millus/ilm' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/millus/ilm' or
                                      */*[local-name()='code']='ilm'">p</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vIllusPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vIllus"/>
                    <xsl:with-param name="pStringLength">4</xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vIllusPadded) &gt; 4">
                    <xsl:value-of select="substring($vIllusPadded,1,4)"/>
                  </xsl:when>
                  <xsl:otherwise><xsl:value-of select="$vIllusPadded"/></xsl:otherwise>
                </xsl:choose>
              </transform>
            </case>
          </switch>
        </position>

        <!-- 22 -->
        <position default=" ">
          <switch>
            <case test="$v008Format='BK' or
                        $v008Format='CF' or
                        $v008Format='MU' or
                        $v008Format='VM'">
              <select xpath="bf:Work/bf:intendedAudience">
                <switch>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/pre' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/pre' or
                              */*[local-name='code']='pre'">a</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/pri' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/pri' or
                              */*[local-name='code']='pri'">b</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/pad' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/pad' or
                              */*[local-name='code']='pad'">c</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/ado' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/ado' or
                              */*[local-name='code']='ado'">d</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/adu' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/adu' or
                              */*[local-name='code']='adu'">e</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/spe' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/spe' or
                              */*[local-name='code']='spe'">f</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/gen' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/gen' or
                              */*[local-name='code']='gen'">g</case>
                  <case test="@rdf:resource='http://id.loc.gov/vocabulary/maudience/juv' or
                              */@rdf:about='http://id.loc.gov/vocabulary/maudience/juv' or
                              */*[local-name='code']='juv'">j</case>
                </switch>
              </select>
            </case>
          </switch>
        </position>

        <!-- 23 -->
        <position default=" ">
          <switch>
            <case test="$v008Format='BK' or
                        $v008Format='MU' or
                        $v008Format='CR' or
                        $v008Format='MX'">
              <switch>
                <case test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/h'] or
                            bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/h'] or
                            bf:Instance/bf:carrier/*/*[local-name()='code']='h'">a</case>
                <case test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/he'] or
                            bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/he'] or
                            bf:Instance/bf:carrier/*/*[local-name()='code']='he'">b</case>
                <case test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/hg'] or
                            bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/hg'] or
                            bf:Instance/bf:carrier/*/*[local-name()='code']='hg'">c</case>
                <case test="bf:Instance/bf:carrier[@rdf:resource='http://id.loc.gov/vocabulary/mediaTypes/cr'] or
                            bf:Instance/bf:carrier/*[@rdf:about='http://id.loc.gov/vocabulary/mediaTypes/cr'] or
                            bf:Instance/bf:carrier/*/*[local-name()='code']='cr'">o</case>
                <case test="bf:Instance/bf:carrier/*/rdfs:label='direct electronic'">q</case>
                <case test="bf:Instance/bf:carrier/*/rdfs:label='regular print reproduction'">r</case>
                <case test="bf:Instance/bf:carrier/*/rdfs:label='electronic'">s</case>
                <case test="bf:Instance/bf:fontSize/*/rdfs:label='large print'">d</case>
                <case test="bf:Instance/bf:notation/*/rdfs:label='braille'">f</case>
              </switch>
            </case>
          </switch>
        </position>

        <!-- 24-27 -->
        <position default="    ">
          <switch>
            <case test="$v008Format='BK'">
              <transform>
                <xsl:variable name="vNoC">
                  <xsl:for-each select="bf:Work/bf:genreForm">
                    <xsl:choose>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026038' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026038'">a</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026048' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026048'">b</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026057' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026057'">c</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026086' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026086'">d</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026092' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026092'">e</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026109' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026109'">f</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026351' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026351'">g</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026049' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026049'">h</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026112' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026112'">i</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026438' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026438'">j</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026088' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026088'">k</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026611' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026611'">l</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026039' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026039'">m</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/sur' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/marcgt/sur'">n</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026168' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026168'">o</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026155' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026155'">p</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/fil' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/marcgt/fil'">q</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026087' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026087'">r</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026181' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026181'">s</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2015026093' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2015026093'">t</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/stp' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/marcgt/stp'">u</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026352' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026352'">v</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026349' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026349'">w</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026208' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026208'">y</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026707' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026707'">z</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/vocabulary/marcgt/off' or
                                      */@rdf:about='http://id.loc.gov/vocabulary/marcgt/off'">2</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026055' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026055'">5</xsl:when>
                      <xsl:when test="@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026362' or
                                      */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026362'">6</xsl:when>
                    </xsl:choose>
                  </xsl:for-each>
                </xsl:variable>
                <xsl:variable name="vNoCPadded">
                  <xsl:call-template name="tPadRight">
                    <xsl:with-param name="pInput" select="$vNoC"/>
                    <xsl:with-param name="pStringLength">4</xsl:with-param>
                  </xsl:call-template>
                </xsl:variable>
                <xsl:choose>
                  <xsl:when test="string-length($vNoCPadded) &gt; 4">
                    <xsl:value-of select="substring($vNoCPadded,1,4)"/>
                  </xsl:when>
                  <xsl:otherwise><xsl:value-of select="$vNoCPadded"/></xsl:otherwise>
                </xsl:choose>
              </transform>
            </case>
          </switch>
        </position>

        <!-- 28 -->
        <position default=" ">
          <switch>
            <case test="$v008Format='BK' or
                        $v008Format='CF' or
                        $v008Format='MP' or
                        $v008Format='CR' or
                        $v008Format='VM'">
              <select xpath="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/vocabulary/marcgt/gov' or */@rdf:about='http://id.loc.gov/vocabulary/marcgt/gov']">
                <switch>
                  <case test="contains(*/rdfs:label,'autonomous')">a</case>
                  <case test="contains(*/rdfs:label,'multilocal')">c</case>
                  <case test="contains(*/rdfs:label,'federal')">f</case>
                  <case test="contains(*/rdfs:label,'international')">i</case>
                  <case test="contains(*/rdfs:label,'local')">l</case>
                  <case test="contains(*/rdfs:label,'state')">s</case>
                  <case test="default">o</case>
                </switch>
              </select>
            </case>
          </switch>
        </position>

        <!-- 29 -->
        <position default="|">
          <switch>
            <case test="$v008Format='BK' or
                        $v008Format='CR'">
              <switch>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026068' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026068']">1</case>
                <case test="default">0</case>
              </switch>
            </case>
          </switch>
        </position>

        <!-- 30 -->
        <position default="|">
          <switch>
            <case test="$v008Format='BK'">
              <switch>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2016026082' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2016026082']">1</case>
                <case test="default">0</case>
              </switch>
            </case>
          </switch>
        </position>

        <!-- 31 -->
        <position default="|">
          <switch>
            <case test="$v008Format='BK' or
                        $v008Format='MP'">
              <switch>
                <case test="bf:Instance/bf:supplementaryContent/*[contains(rdfs:label,'index')]">1</case>
              </switch>
            </case>
          </switch>
        </position>

        <!-- 32 -->
        <position default=" "/>

        <!-- 33 -->
        <position default="|">
          <switch>
            <case test="$v008Format='BK'">
              <switch>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026339' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026339']">1</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026297' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026297']">d</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026094' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026094']">e</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2015026020' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2015026020']">f</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026110' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026110']">h</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026141' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026141']">i</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026542' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026542']">j</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026339' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026339']">m</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026481' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026481']">p</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2011026363' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2011026363']">s</case>
              </switch>
            </case>
          </switch>
        </position>

        <!-- 34 -->
        <position default=" ">
          <switch>
            <case test="$v008Format='BK'">
              <switch>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026047' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026047']">a</case>
                <case test="bf:Work/bf:genreForm[@rdf:resource='http://id.loc.gov/authorities/genreForms/gf2014026049' or */@rdf:about='http://id.loc.gov/authorities/genreForms/gf2014026049']">d</case>
              </switch>
            </case>
          </switch>
        </position>

        <!-- 35-37 -->
        <position default="   ">
          <!-- will need to rely on the first bf:language property, there will likely be warnings -->
          <select xpath="bf:Work/bf:language[@rdf:resource]|bf:Work/bf:language[*/@rdf:about]|bf:Work/bf:language[*/*[local-name()='code']]">
            <switch>
              <case test="*/*[local-name()='code']">
                <switch>
                  <case test="string-length(*/*[local-name()='code']) = 3">
                    <transform><xsl:value-of select="*/*[local-name()='code']"/></transform>
                  </case>
                </switch>
              </case>
              <case test="*[starts-with(@rdf:about,'http://id.loc.gov/vocabulary/languages/')] or starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                <transform>
                  <xsl:variable name="vCode">
                    <xsl:choose>
                      <xsl:when test="*[starts-with(@rdf:about,'http://id.loc.gov/vocabulary/languages/')]">
                        <xsl:value-of select="substring-after(*/@rdf:about,'http://id.loc.gov/vocabulary/languages/')"/>
                      </xsl:when>
                      <xsl:when test="starts-with(@rdf:resource,'http://id.loc.gov/vocabulary/languages/')">
                        <xsl:value-of select="substring-after(@rdf:resource,'http://id.loc.gov/vocabulary/languages/')"/>
                      </xsl:when>
                    </xsl:choose>
                  </xsl:variable>
                  <xsl:if test="string-length($vCode)=3"><xsl:value-of select="$vCode"/></xsl:if>
                </transform>
              </case>
            </switch>
          </select>
        </position>

        <!-- 38-39 -->
        <position default=" |"/>

      </fixed-field>
    </context>
  </cf>

</rules>
