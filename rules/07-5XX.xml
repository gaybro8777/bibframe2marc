<?xml version='1.0'?>
<rules xmlns="http://www.loc.gov/bf2marc"
       xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
       xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
       xmlns:bf="http://id.loc.gov/ontologies/bibframe/"
       xmlns:bflc="http://id.loc.gov/ontologies/bflc/"
       xmlns:madsrdf="http://www.loc.gov/mads/rdf/v1#"
       xmlns:marc="http://www.loc.gov/MARC21/slim"
       xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

  <!-- I know, a 490 isn't a 5XX -->
  <switch>
    <case test="bf:Instance/bf:seriesStatement or bf:Instance/bf:seriesEnumeration">
      <df tag="490">
        <ind1 default="0"/>
        <ind2 default=" "/>
        <select xpath="bf:Instance/bf:seriesStatement|bf:Instance/bf:seriesEnumeration">
          <switch>
            <case test="local-name()='seriesStatement'">
              <sf code="a"><select xpath="."/></sf>
            </case>
            <case test="default">
              <sf code="v"><select xpath="."/></sf>
            </case>
          </switch>
        </select>
      </df>
    </case>
  </switch>

  <!-- notes -->
  <select xpath="bf:Instance/bf:note/bf:Note|bf:Work/bf:note/bf:Note">
    <switch>
      <case test="local-name(../..)='Instance' and bf:noteType='with'">
        <df tag="501">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label"/>
          </sf>
          <sf code="5" repeatable="false">
            <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and bf:noteType='report type'">
        <df tag="513">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and bf:noteType='issuance information'">
        <df tag="515">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and bf:noteType='type of computer data'">
        <df tag="516">
          <ind1 default="8"/>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and bf:noteType='funding information'">
        <df tag="536">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <select xpath="rdfs:label">
            <switch>
              <case test="starts-with(.,'Contract:')">
                <sf code="b">
                  <transform><xsl:value-of select="normalize-space(substring-after(.,'Contract:'))"/></transform>
                </sf>
              </case>
              <case test="starts-with(.,'Grant:')">
                <sf code="c">
                  <transform><xsl:value-of select="normalize-space(substring-after(.,'Grant:'))"/></transform>
                </sf>
              </case>
              <case test="starts-with(.,'Program element:')">
                <sf code="e">
                  <transform><xsl:value-of select="normalize-space(substring-after(.,'Program element:'))"/></transform>
                </sf>
              </case>
              <case test="starts-with(.,'Project:')">
                <sf code="f">
                  <transform><xsl:value-of select="normalize-space(substring-after(.,'Project:'))"/></transform>
                </sf>
              </case>
              <case test="starts-with(.,'Task:')">
                <sf code="g">
                  <transform><xsl:value-of select="normalize-space(substring-after(.,'Task:'))"/></transform>
                </sf>
              </case>
              <case test="starts-with(.,'Work unit:')">
                <sf code="h">
                  <transform><xsl:value-of select="normalize-space(substring-after(.,'Work unit:'))"/></transform>
                </sf>
              </case>
              <case test="default">
                <sf code="a"><select xpath="."/></sf>
              </case>
            </switch>
          </select>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and
                  (bf:noteType='biographical data' or bf:noteType='administrative history')">
        <df tag="545">
          <ind1 default=" ">
            <switch>
              <case test="bf:noteType='biographical data'">0</case>
              <case test="bf:noteType='administrative history'">1</case>
            </switch>
          </ind1>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]"/>
          </sf>
          <sf code="u">
            <select xpath="rdfs:label[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and bf:noteType='issuing body'">
        <df tag="550">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and
                  (bf:noteType='index' or bf:noteType='finding aid')">
        <df tag="555">
          <ind1 default="8">
            <switch>
              <case test="bf:noteType='index'"><text> </text></case>
              <case test="bf:noteType='finding aid'">0</case>
            </switch>
          </ind1>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]"/>
          </sf>
          <sf code="u">
            <select xpath="rdfs:label[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
          </sf>
        </df>
      </case>

      <case test="local-name(../..)='Instance' and bf:noteType='related material'">
        <df tag="581">
          <ind1 default="8"/>
          <ind2 default=" "/>
          <sf code="a" repeatable="false">
            <select xpath="rdfs:label"/>
          </sf>
          <sf code="z">
            <select xpath="bf:identifiedBy/*[local-name()='Isbn' or rdf:type/rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']/rdf:value"/>
          </sf>
        </df>
      </case>

      <case test="default">
        <df tag="500">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <sf code="3" repeatable="false">
            <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
          </sf>
          <sf code="a" repeatable="false">
            <transform>
              <xsl:for-each select="rdfs:label">
                <xsl:choose>
                  <xsl:when test="position() = last()">
                    <xsl:value-of select="."/>
                  </xsl:when>
                  <xsl:otherwise><xsl:value-of select="concat(.,' ')"/></xsl:otherwise>
                </xsl:choose>
              </xsl:for-each>
            </transform>
          </sf>
          <sf code="5" repeatable="false">
            <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
          </sf>
        </df>
      </case>
    </switch>
  </select>

  <df tag="502">
    <context xpath="bf:Work/bf:dissertation/bf:Dissertation">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="b" repeatable="false">
        <select xpath="bf:degree"/>
      </sf>
      <sf code="c" repeatable="false">
        <select xpath="bf:grantingInstitution/*/rdfs:label"/>
      </sf>
      <sf code="d" repeatable="false">
        <select xpath="bf:date"/>
      </sf>
      <sf code="g">
        <select xpath="bf:note/*/rdfs:label"/>
      </sf>
      <sf code="o">
        <select xpath="bf:identifiedBy/*/rdf:value"/>
      </sf>
    </context>
  </df>

  <df tag="505">
    <context xpath="bf:Work/bf:tableOfContents/bf:TableOfContents">
      <ind1 default="0"/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false"><select xpath="rdfs:label"/></sf>
    </context>
  </df>

  <df tag="506">
    <context xpath="bf:Instance/bf:usageAndAccessPolicy/*">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]"/>
      </sf>
      <sf code="u">
        <select xpath="rdfs:label[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
      <sf code="2" repeatable="false">
        <select xpath="bf:source/bf:Source/rdfs:label"/>
      </sf>
      <sf code="5" repeatable="false">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="507">
    <context xpath="bf:Work/bf:scale/*/bf:note/bf:Note">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
    </context>
  </df>

  <df tag="508">
    <context xpath="bf:Instance/bf:credits[not(starts-with(text(),'Cast:'))]">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="."/>
      </sf>
    </context>
  </df>

  <df tag="510">
    <context xpath="bf:Work/bflc:indexedIn/bf:Work|bf:Work/bf:references/bf:Work">
      <ind1 default="0">
        <switch>
          <case test="local-name(..)='indexedIn' and bf:note/bf:Note[bf:noteType='Coverage']">2</case>
          <case test="local-name(..)='references' and bf:note/bf:Note[bf:noteType='Location']">4</case>
          <case test="local-name(..)='references'">3</case>
        </switch>
      </ind1>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="bf:title/*">
          <switch>
            <case test="bf:mainTitle"><select xpath="bf:mainTitle"/></case>
            <case test="default"><select xpath="rdfs:label"/></case>
          </switch>
        </select>
      </sf>
      <sf code="b" repeatable="false">
        <select xpath="bf:note/bf:Note[bf:noteType='Coverage']/rdfs:label"/>
      </sf>
      <sf code="c" repeatable="false">
        <select xpath="bf:note/bf:Note[bf:noteType='Location']/rdfs:label"/>
      </sf>
      <sf code="x" repeatable="false">
        <select xpath="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value"/>
      </sf>
    </context>
  </df>

  <df tag="511">
    <context xpath="bf:Instance/bf:credits[starts-with(text(),'Cast:')]">
      <ind1 default="1"/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <transform><xsl:value-of select="normalize-space(substring-after(.,'Cast:'))"/></transform>
      </sf>
    </context>
  </df>

  <df tag="518">
    <context xpath="bf:Work/bf:capture/bf:Capture[not(bf:date) and not(bf:place)]">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
    </context>
  </df>

  <df tag="520">
    <context xpath="bf:Work/bf:summary/bf:Summary">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="u">
        <select xpath="bf:source/bf:Source/rdfs:label[@rdf:dataype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
    </context>
  </df>

  <!-- rules for 521 coded with 385 -->

  <!-- rules for 522 coded with 052 -->
  <df tag="524">
    <context xpath="bf:Instance/bf:preferredCitation">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a"><select xpath="."/></sf>
    </context>
  </df>

  <df tag="525">
    <context xpath="*[local-name()='Instance' or local-name()='Work']/bf:supplementaryContent/bf:SupplementaryContent">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false"><select xpath="rdfs:label"/></sf>
    </context>
  </df>

  <!-- 530/776 -->
  <select xpath="//bf:Instance[@rdf:about=//bf:Instance/bf:otherPhysicalFormat/@rdf:resource]">
    <switch>
      <!-- 776 -->
      <case test="bf:contribution or bf:editionStatement or bf:provisionActivityStatement or
                  bf:part or bf:extent or bflc:relationship or bf:seriesStatement"/>
      <!-- 530 -->
      <case test="default">
        <df tag="530">
          <ind1 default=" "/>
          <ind2 default=" "/>
          <sf code="3" repeatable="false">
            <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
          </sf>
          <sf code="a" repeatable="false">
            <select xpath="bf:note/bf:Note/rdfs:label"/>
          </sf>
          <sf code="b" repeatable="false">
            <select xpath="bf:acquisitionSource/bf:AcquisitionSource/rdfs:label"/>
          </sf>
          <sf code="c" repeatable="false">
            <select xpath="bf:acquisitionTerms"/>
          </sf>
          <sf code="d" repeatable="false">
            <select xpath="bf:identifiedBy/*[local-name()='StockNumber' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/StockNumber']/rdf:value"/>
          </sf>
          <sf code="u">
            <select xpath="bf:hasItem/bf:Item/bf:electronicLocator"/>
          </sf>
        </df>
      </case>
    </switch>
  </select>

  <df tag="532">
    <context xpath="bf:Instance/bf:contentAccessibility/bf:ContentAccessibility/rdfs:label">
      <ind1 default="8"/>
      <ind2 default=" "/>
      <sf code="a"><select xpath="."/></sf>
    </context>
  </df>

  <df tag="533">
    <context xpath="//bf:Instance[@rdf:about=//bf:Instance/bf:hasReproduction/@rdf:resource]">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="bf:carrier/bf:Carrier/rdfs:label"/>
      </sf>
      <sf code="b">
        <select xpath="bf:provisionActivity/bf:ProvisionActivity/bf:place/*/rdfs:label"/>
      </sf>
      <sf code="c">
        <select xpath="bf:provisionActivity/bf:ProvisionActivity/bf:agent/*/rdfs:label"/>
      </sf>
      <sf code="d" repeatable="false">
        <select xpath="bf:provisionActivity/bf:ProvisionActivity/bf:date"/>
      </sf>
      <sf code="e" repeatable="false">
        <select xpath="bf:extent/bf:Extent/rdfs:label"/>
      </sf>
      <sf code="f">
        <select xpath="bf:seriesStatement"/>
      </sf>
      <sf code="n">
        <select xpath="bf:note/bf:Note/rdfs:label"/>
      </sf>
    </context>
  </df>

  <df tag="534">
    <context xpath="//bf:Instance[@rdf:about=//bf:Instance/bf:originalVersion/@rdf:resource]">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="m" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="bf:contribution/*/bf:agent/*/rdfs:label"/>
      </sf>
      <sf code="b" repeatable="false">
        <select xpath="bf:editionStatement"/>
      </sf>
      <sf code="c" repeatable="false">
        <select xpath="bf:provisionActivityStatement"/>
      </sf>
      <sf code="e" repeatable="false">
        <select xpath="bf:extent/bf:Extent/rdfs:label"/>
      </sf>
      <sf code="f">
        <select xpath="bf:seriesStatement"/>
      </sf>
      <sf code="k">
        <select xpath="bf:title/*[local-name='KeyTitle' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/KeyTitle']/bf:mainTitle"/>
      </sf>
      <sf code="n">
        <select xpath="bf:note/bf:Note/rdfs:label"/>
      </sf>
      <sf code="t" repeatable="false">
        <select xpath="bf:title/bf:Title[not(contains(rdf:type/@rdf:resource,'bibframe'))]/bf:mainTitle"/>
      </sf>
      <sf code="x">
        <select xpath="bf:identifiedBy/*[local-name()='Issn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Issn']/rdf:value"/>
      </sf>
      <sf code="z">
        <select xpath="bf:identifiedBy/*[local-name()='Isbn' or rdf:type/@rdf:resource='http://id.loc.gov/ontologies/bibframe/Isbn']/rdf:value"/>
      </sf>
    </context>
  </df>

  <df tag="538">
    <context xpath="bf:Instance/bf:systemRequirement/bf:SystemRequirement">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="u">
        <select xpath="bf:source/bf:Source/rdfs:label[@rdf:dataype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
      <sf code="5">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="541">
    <context xpath="bf:Instance/bf:hasItem/bf:Item/bf:immediateAcquisition/bf:ImmediateAcquisition">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="5">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="546">
    <context xpath="bf:Work/bf:language/bf:Language[bf:note/bf:Note/rdfs:label]">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="bf:note/bf:Note/rdfs:label"/>
      </sf>
    </context>
  </df>

  <df tag="546">
    <context xpath="bf:Work/bf:notation/bf:Notation">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="b">
        <select xpath="rdfs:label"/>
      </sf>
    </context>
  </df>

  <df tag="561">
    <context xpath="bf:Instance/bf:hasItem/bf:Item/bf:custodialHistory">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="."/>
      </sf>
    </context>
  </df>

  <df tag="563">
    <context xpath="bf:Instance/bf:hasItem/bf:Item/bf:note/bf:Note[bf:noteType='binding']">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="5">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="583">
    <context xpath="bf:Instance/bf:hasItem/bf:Item/bf:note/bf:Note[bf:noteType='action']">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <transform>
          <xsl:variable name="vLabel">
            <xsl:for-each select="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]">
              <xsl:value-of select="concat(.,' ')"/>
            </xsl:for-each>
          </xsl:variable>
          <xsl:value-of select="normalize-space($vLabel)"/>
        </transform>
      </sf>
      <sf code="c">
        <select xpath="bf:date"/>
      </sf>
      <sf code="k">
        <select xpath="bf:agent/*/rdfs:label"/>
      </sf>
      <sf code="l">
        <select xpath="bf:status/*/rdfs:label"/>
      </sf>
      <sf code="u">
        <select xpath="rdfs:label[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
      <sf code="z">
        <select xpath="bf:note/bf:Note/rdfs:label"/>
      </sf>
      <sf code="2" repeatable="false">
        <select xpath="bf:source/bf:Source/rdfs:label"/>
      </sf>
      <sf code="5">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

</rules>
