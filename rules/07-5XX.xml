<?xml version='1.0'?>
<rules xmlns="http://www.loc.gov/bf2marc"
       xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
       xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
       xmlns:bf="http://id.loc.gov/ontologies/bibframe/"
       xmlns:bflc="http://id.loc.gov/ontologies/bflc/"
       xmlns:madsrdf="http://www.loc.gov/mads/rdf/v1#"
       xmlns:marc="http://www.loc.gov/MARC21/slim"
       xmlns:xsl="http://www.w3.org/1999/XSL/Transform">

  <!-- I know, a 490 isn't a 5XX -->
  <switch>
    <case test="bf:Instance/bf:seriesStatement or bf:Instance/bf:seriesEnumeration">
      <df tag="490">
        <ind1 default="0"/>
        <ind2 default=" "/>
        <select xpath="bf:Instance/bf:seriesStatement|bf:Instance/bf:seriesEnumeration">
          <switch>
            <case test="local-name()='seriesStatement'">
              <sf code="a"><select xpath="."/></sf>
            </case>
            <case test="default">
              <sf code="v"><select xpath="."/></sf>
            </case>
          </switch>
        </select>
      </df>
    </case>
  </switch>

  <df tag="500">
    <context xpath="bf:Instance/bf:note/bf:Note[not(bf:noteType)]|bf:Work/bf:note/bf:Note[not(bf:noteType)]">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <transform>
          <xsl:for-each select="rdfs:label">
            <xsl:choose>
              <xsl:when test="position() = last()">
                <xsl:value-of select="."/>
              </xsl:when>
              <xsl:otherwise><xsl:value-of select="concat(.,' ')"/></xsl:otherwise>
            </xsl:choose>
          </xsl:for-each>
        </transform>
      </sf>
      <sf code="5" repeatable="false">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="501">
    <context xpath="bf:Instance/bf:note/bf:Note[bf:noteType='with']">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="5" repeatable="false">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="502">
    <context xpath="bf:Work/bf:dissertation/bf:Dissertation">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="b" repeatable="false">
        <select xpath="bf:degree"/>
      </sf>
      <sf code="c" repeatable="false">
        <select xpath="bf:grantingInstitution/*/rdfs:label"/>
      </sf>
      <sf code="d" repeatable="false">
        <select xpath="bf:date"/>
      </sf>
      <sf code="g">
        <select xpath="bf:note/*/rdfs:label"/>
      </sf>
      <sf code="o">
        <select xpath="bf:identifiedBy/*/rdf:value"/>
      </sf>
    </context>
  </df>

  <df tag="505">
    <context xpath="bf:Work/bf:tableOfContents/bf:TableOfContents">
      <ind1 default="0"/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false"><select xpath="rdfs:label"/></sf>
    </context>
  </df>

  <df tag="506">
    <context xpath="bf:Instance/bf:usageAndAccessPolicy/*">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label[not(@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI')]"/>
      </sf>
      <sf code="u">
        <select xpath="rdfs:label[@rdf:datatype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
      <sf code="5" repeatable="false">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

  <df tag="507">
    <context xpath="bf:Instance/bf:scale">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <switch>
          <case test="bf:Scale"><select xpath="bf:Scale/rdfs:label"/></case>
          <case test="default"><transform><xsl:value-of select="."/></transform></case>
        </switch>
      </sf>
    </context>
  </df>

  <df tag="511">
    <context xpath="bf:Instance/bf:credits[starts-with(text(),'Cast:')]">
      <ind1 default="1"/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false">
        <transform><xsl:value-of select="normalize-space(substring-after(.,'Cast:'))"/></transform>
      </sf>
    </context>
  </df>

  <df tag="520">
    <context xpath="bf:Work/bf:summary/bf:Summary">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="u">
        <select xpath="bf:source/bf:Source/rdfs:label[@rdf:dataype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
    </context>
  </df>

  <df tag="525">
    <context xpath="*[local-name()='Instance' or local-name()='Work']/bf:supplementaryContent/bf:SupplementaryContent">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="a" repeatable="false"><select xpath="rdfs:label"/></sf>
    </context>
  </df>

  <df tag="538">
    <context xpath="bf:Instance/bf:systemRequirement/bf:SystemRequirement">
      <ind1 default=" "/>
      <ind2 default=" "/>
      <sf code="3" repeatable="false">
        <select xpath="bflc:appliesTo/bflc:AppliesTo/rdfs:label"/>
      </sf>
      <sf code="a" repeatable="false">
        <select xpath="rdfs:label"/>
      </sf>
      <sf code="u">
        <select xpath="bf:source/bf:Source/rdfs:label[@rdf:dataype='http://www.w3.org/2001/XMLSchema#anyURI']"/>
      </sf>
      <sf code="5">
        <select xpath="bflc:applicableInstitution/bf:Agent/bf:code"/>
      </sf>
    </context>
  </df>

</rules>
